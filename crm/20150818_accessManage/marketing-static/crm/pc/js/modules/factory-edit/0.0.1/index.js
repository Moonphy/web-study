define("modules/factory-edit/0.0.1/index",["common","upload","loadcity","validate"],function(require,exports,module){var factoryEdit,common=require("common"),$=common.jquery,upload=($.layer,require("upload")),loadcity=require("loadcity");require("validate")($,!0),$(function(){function loadInfo(id){$.ajax({url:"/org/find/specif",data:"orgID="+encodeURIComponent(id),callback:function(model){setDatas(model)}})}function setDatas(model){function _$(name){return $('input[name="'+name+'"]')}var id=$("#id"),auditTime=$("#auditTime"),filter=$("#filter"),createTime=$("#createTime"),orgType=$("#orgType"),feilds=["mfctyName","businessLicenseNo","legalPerson","identityNo","orgType","contactPerson","contactMobile","businessTelephone","fax","email","address"],keys=["mfctyName","businessLicenseNo","legalPerson","identityNo","orgType","contactPerson","contactMobile","businessTelephone","fax","email","address"],baseInfo=model.qpuOrgEntity;id.text(baseInfo.orgID),auditTime.text(baseInfo.auditTime),createTime.text(baseInfo.createTime),model.isFilter&&model.isFilter===!0&&filter.attr("checked","checked"),void 0!=baseInfo.businessLicensePic&&""!=baseInfo.businessLicensePic&&gszz.attr("src",decodeURIComponent(baseInfo.businessLicensePic)),orgType.val(baseInfo.orgType),feilds.forEach(function(name,i){_$(name).val(baseInfo[keys[i]])}),loadcity.loadProvince(province,baseInfo.provinceID),loadcity.loadCity(city,baseInfo.provinceID,baseInfo.cityID),loadcity.loadArea(area,baseInfo.cityID,baseInfo.countyID);var pics=model.orgFacadePics;pics&&pics.forEach(function(src){var img=document.createElement("img");img.src=decodeURIComponent(src),imglist.append(img)})}function uploadInit(){gszzLoading.hide();new upload.initalize({browse_button:"uploadbtn1",container:"container1",drop_element:"container1",uptoken:token,downloadUrl:domain,multi_selection:!1,filters:filters,max_file_size:"10mb",init:{UploadFile:function(up,file){gszzLoading.show(),gszz.hide()},FileUploaded:function(up,file,info){var res=JSON.parse(info),url=upload.sdk.imageView2({mode:2,w:216,h:180,quality:70},res.key);gszzLoading.hide(),gszz.attr("src",url).show()}}})}function haveImgCount(){return imglist.find("img").length}function uploadInit2(){var uper=new upload.initalize({browse_button:"uploadbtn2",container:"container2",drop_element:"container2",uptoken:token,downloadUrl:domain,filters:filters,max_file_size:"10mb",init:{UploadFile:function(up,file){if(haveImgCount()<4){var div=document.createElement("div");div.className="uploading";var i=document.createElement("i");i.className="fa fa-spinner fa-spin fa-2x";var span=document.createElement("span");file.loading=div,file.process=span,div.appendChild(i),div.appendChild(span),imglist.append(div)}else uper.uploader.splice(),$.alert("门头照片最多四张，多出的照片不会上传！","i")},UploadProgress:function(up,file){},FileUploaded:function(up,file,info){var res=JSON.parse(info),url=upload.sdk.imageView2({mode:1,w:245,h:205,quality:70},res.key),img=document.createElement("img");img.src=url,img.name="urlPic",$(file.loading).replaceWith(img)}}})}function save(){var json=form.serializeObject();json[encodeURIComponent(gszz.attr("name"))]=encodeURIComponent(gszz.attr("src"));var imgs=$(imglist[0]).find("img"),arr=[];$.each(imgs,function(i,img){arr.push(encodeURIComponent(img.getAttribute("src")))}),json.urlPic=arr,json.orgID=encodeURIComponent(id),json.provinceName=province.find("option:selected").text(),json.cityName=city.find("option:selected").text(),json.countyName=area.find("option:selected").text(),$.ajax({url:"/org/edit/mfcty",type:"POST",traditional:!0,data:json,errorMsg:"抱歉，信息更新失败！",callback:function(){$.alert("信息更新成功！","s")}})}var province=$("#province"),city=$("#city"),area=$("#area"),container2=$("#container2"),imglist=$(".imglist"),gszz=$("#gszz"),gszzLoading=$(".gszzLoading"),deletebtn=$(".deletebtn"),filters=[{title:"图片文件",extensions:"bmp"},{title:"图片文件",extensions:"jpeg"},{title:"图片文件",extensions:"jpg"},{title:"图片文件",extensions:"png"},{title:"图片文件",extensions:"gif"}],form=$("#form"),id=($("#saveBtn"),$.utils.getqs("id"));if($.isEmpty(id))return void $.keyNotFound();loadInfo(id),province.on("change",function(){var val=province.val();city.find(":not(:first)").remove(),area.find(":not(:first)").remove(),val&&loadcity.loadCity(city,val)}),city.on("change",function(){var val=city.val();val&&(area.find(":not(:first)").remove(),loadcity.loadArea(area,val))});var token=null,domain="";$.ajax({url:"/cdn/qn/token",async:!1,errorMsg:"token获取失败，请刷新重试！",callback:function(model){token=model.token,domain=model.domain}}),uploadInit(),uploadInit2(),container2.on("mouseover","img",function(){var left=this.offsetLeft,top=this.offsetTop;deletebtn.css({left:left,top:top}).removeClass("fn-hide"),$(this).addClass("predelete")}),container2.on("mouseout","img",function(){deletebtn.addClass("fn-hide"),$(this).removeClass("predelete")}),container2.on("dblclick","img",function(){$(this).remove(),deletebtn.addClass("fn-hide")}),form.on("focus","input",function(e){$(this).hasClass("active")&&$(".errortip").css({top:$(this)[0].offsetTop+36,left:$(this)[0].offsetLeft}).text($(this).attr("msg")||$(this).attr("placeholder")).show()}),form.on("blur","input",function(){$(".errortip").hide()}),form.Validform({btnSubmit:"#saveBtn",tiptype:function(msg,o,cssctl){3==o.type?(o.obj.addClass("active").attr("msg",msg),"select"==o.obj[0].localName&&$.layer.tips(msg,o.obj,{tips:[1,"#df0007"]})):o.obj.addClass("pass").removeClass("active")},beforeSubmit:function(curform){return save(),!1}})}),module.exports=factoryEdit});