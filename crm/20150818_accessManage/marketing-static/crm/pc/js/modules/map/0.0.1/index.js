define("modules/map/0.0.1/index",["common","moment","loadcity","pagination","laydate"],function(require,exports,module){function isEmpty(val){return void 0==val||null==val||""==val?!0:!1}function addMarker(map,point,orgName,address,tel,isopen){var marker=new BMap.Marker(point);map.addOverlay(marker),openDialog(map,marker,point,orgName,address,tel,isopen)}function parse(map,id,address,cityName,orgName,tel,isopen){var myGeo=new BMap.Geocoder;myGeo.getPoint(address,function(point){if(point){var point1=new BMap.Point(point.lng,point.lat);index.lastPoint=point1,addMarker(map,point1,orgName,address,tel,isopen),savepoint(id,point1)}else myGeo.getPoint(orgName,function(point){if(point){var point1=new BMap.Point(point.lng,point.lat);index.lastPoint=point1,addMarker(map,point1,orgName,address,tel,isopen),savepoint(id,point1)}else isopen&&openFailDialog(map,index.lastPoint,orgName,address)})},cityName)}function openMap(map,id,lng,lat,address,cityName,orgName,tel,isopen){if(isEmpty(lng)||isEmpty(lat))parse(map,id,address,cityName,orgName,tel,isopen);else{var point=new BMap.Point(lng,lat);addMarker(map,point,orgName,address,tel,isopen),index.map.centerAndZoom(point,13),savepoint(id,point)}}function openFailDialog(map,point,orgName,address){var sContent="抱歉，没有未找到相关地点。<br/>签到地址:"+address+"<br/>",infoWindow=new BMap.InfoWindow(sContent);map.centerAndZoom(point,13),map.enableScrollWheelZoom(),map.openInfoWindow(infoWindow,point)}function openDialog(map,marker,point,orgName,address,tel,isopen){var sContent="签到地址:"+address,infoWindow=new BMap.InfoWindow(sContent);isopen&&map.openInfoWindow(infoWindow,point),marker.addEventListener("click",function(){this.openInfoWindow(infoWindow)})}function savepoint(id,point){if(index.lastPoint=point,index.agent.agentId==id)index.agentPoint=point;else{$("#"+id).attr("lng",point.lng),$("#"+id).attr("lat",point.lat)}}var crmmap,common=require("common"),$=common.jquery,index=($.layer,require("moment"),require("loadcity"),require("pagination"),require("laydate"),{lastPoint:null,agentPoint:null,map:new BMap.Map("allmap"),inner:!1,agent:{cityName:"",lng:null,lat:null,address:"",orgName:"",tel:"",agentId:null},init:function(){this.init_map();var agent=index.agent;$("#menu li a[id]").on("click",function(){var id=$(this).attr("id"),tel=$(this).attr("tel"),lng=$(this).attr("lng"),lat=$(this).attr("lat"),orgName=$(this).attr("orgName"),address=$(this).attr("address");openMap(index.map,id,lng,lat,address,agent.cityName,orgName,tel,!0),index.map.centerAndZoom(index.lastPoint,13),index.map.enableScrollWheelZoom(!0)})},init_map:function(){var agent=index.agent;agent.cityName=$("#cityName").val(),agent.lng=$("#lng").val(),agent.lat=$("#lat").val(),agent.address=$("#address").val(),agent.orgName=$("#orgName").val(),agent.tel=$("#tel").val(),agent.agentId=$("#agentId").val(),index.lastPoint=new BMap.Point(agent.lng,agent.lat),openMap(index.map,agent.agentId,agent.lng,agent.lat,agent.address,agent.cityName,agent.orgName,agent.tel,!0),$("#menu li a[id]").each(function(){var id=$(this).attr("id"),tel=$(this).attr("tel"),lng=$(this).attr("lng"),lat=$(this).attr("lat"),orgName=$(this).attr("orgName"),address=$(this).attr("address");openMap(index.map,id,lng,lat,address,agent.cityName,orgName,tel,!1)}),index.lastPoint&&index.map.centerAndZoom(index.lastPoint,13),index.map.enableScrollWheelZoom(!0);var interval=setInterval(function(){var logos=$('a[href^="http://map.baidu.com"]'),copy=$(".BMap_cpyCtrl");logos.length>0&&copy.length>0&&(logos.remove(),copy.remove(),clearInterval(interval))});$("#allmap").css({height:document.body.clientHeight-350}),$("#menu").css({"max-height":520,overflow:"auto"})}});index.init(),module.exports=crmmap});