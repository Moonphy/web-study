define("modules/coupon-edit/0.0.1/index",["common","layer","laydate","tpl","moment","modules/coupon-edit/0.0.1/src/list-tpl"],function(require,exports,module){function query(){$.ajax({url:"/coupon/find/specif",data:"orgID="+encodeURIComponent(id),errorMsg:"抱歉，拉取数据失败！",callback:function(data){keys.forEach(function(key){document.querySelector("#"+key).innerHTML=data[key]}),list.empty(),tpl(listtpl).render(data,function(render){list.append(render.replace(/undefined/g,"").replace(/null/g,""));var _start;list.find(".time").each(function(idx,time){var self=$(time),id="time"+idx;if(self.attr("id",id),idx%2==0)_start={elem:"#"+id,format:"YYYY-MM-DD hh:mm:ss",event:"focus",istime:!0};else{var _end={elem:"#"+id,format:"YYYY-MM-DD hh:mm:ss",event:"focus",istime:!0,choose:function(datas){_start.max=datas}};_start.choose=function(datas){_end.min=datas,_end.start=datas,$("#"+id).val(moment(datas).add(60,"days").format(dataformat)).removeClass("error")},laydate(_start),laydate(_end),_start={}}})})}})}var couponList,common=require("common"),$=common.jquery,layer=require("layer"),laydate=require("laydate"),tpl=require("tpl"),moment=require("moment"),listtpl=require("modules/coupon-edit/0.0.1/src/list-tpl"),list=$("#list"),id=$.utils.getqs("id");if($.isEmpty(id))return void $.keyNotFound();var dataformat="YYYY-MM-DD HH:mm:ss",keys=["mfctyName","orgID","contactPerson","address","contactMobile","auditTime"];query();var resetBtn=$("#resetBtn"),submitBtn=$("#submitBtn");resetBtn.on("click",function(){var unuseds=list.find("input.unused");if(unuseds.length<=0)return void $.alert("优惠券信息已经重置，不需要再次重置。","w");var arr=[];return $.each(unuseds,function(idx,unused){unused=$(unused),parseInt(unused.data("old"))>0&&arr.push("flag")}),arr.length>0||unuseds.length<list.find("tr").length?void $.alert("此用户存在未使用的优惠券，不能重置优惠券信息。","w"):void layer.confirm("你确定要重置此汽修厂的所有优惠券信息吗？",{icon:3,title:"提示"},function(){$.ajax({url:"/coupon/edit/resetCoupon",data:"orgID="+encodeURIComponent(id),errorMsg:"抱歉，重置失败！",callback:function(){$.alert("已完成重置！","s",{end:function(){query()}})}})})}),list.on("blur","input",function(){var self=$(this),tr=self.parents("tr"),input=$(tr.find(".unused")).val();0!=input&&setTimeout(function(){$.isEmpty(self.val())?(layer.tips("不能为空",self),self.addClass("error")):self.removeClass("error")},500)}),list.on("change","input.unused",function(){var self=$(this);if(0===parseInt(self.data("old"))){var tr=self.parents("tr"),times=tr.find(".time");$.each(times,function(idx,time){0!=parseInt(self.val())?$.isEmpty($(time).val())&&$(time).addClass("error"):$(time).removeClass("error").val("")})}}),submitBtn.on("click",function(){var unuseds=list.find("input.unused");if(unuseds.length<=0)return void $.alert("没有信息需要保存。","w");var errors=list.find("input.error");if(errors.length>0)return void layer.tips("不能为空",errors[0]);var trs=list.find("tr"),arr=[];$.each(trs,function(idx,tr){var obj={},tds=$(tr).find("td");$.each(tds,function(jdx,td){td=$(td);var cls=td.attr("class");if(void 0!==cls){var input=td.find("input");if(1==input.length){var val=input[0].value;obj[cls]=val}else obj[cls]=td.text()}}),arr.push(obj)}),arr.length<=0||$.ajax({url:"/coupon/edit/coupon",type:"POST",data:"orgID="+encodeURIComponent(id)+"&totoalCoupons="+JSON.stringify(arr),errorMsg:"抱歉，修改失败！",callback:function(){$.alert("已完成修改！","s",{end:function(){query()}})}})}),list.on("blur",".unused",function(){var self=$(this),val=parseInt(self.val()),min=parseInt(self.attr("min")),max=parseInt(self.attr("max"));return!/\d/.test(val)||val>max||min>val?(layer.tips("只能输入"+min+"到"+max+"之间的数字",self),void self.val(min).trigger("change")):void 0}),module.exports=couponList});