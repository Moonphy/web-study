define("modules/crm-gztj/0.0.1/index",["common","moment","loadcity","pagination","laydate"],function(require,exports,module){function getBaseFilterParams(){var areastr=$(".filter select").serialize();return areastr=void 0==areastr?"":areastr,areastr+"&"+getDateFilterParams()+"&"+getOrderByFilterParams()}function getDateFilterParams(){var datestr="",btn=$(".filter button.active");return datestr=btn.length<=0?$(".filter input").serialize():"start="+startDate.data("date")+"&end="+endDate.data("date"),void 0==datestr?"":datestr}function getOrderByFilterParams(){var sortBy=$('th[scope="sort"].active').data("val")||"";return sortBy}function getOrder2ByFilterParams(){return orderCol2.val()}function loadTop(){var keys=["totalUseCrm","totalVisitNum","totalTaskNum","totalCreateNum"];$.ajax({url:"/statisticsCrm/find/yesterdayCrmAnalyse",callback:function(mode){var inner=$("#inner"),numbers=inner.find(".number");$.each(numbers,function(idx,number){$(number).text(mode[keys[idx]])})}})}function load(page){page=void 0==page?0:page,exporting.attr("href","/statisticsCrm/find/crmUserAnalyseExportExcel?"+encodeURI(getBaseFilterParams())),$.ajax({url:"/statisticsCrm/find/crmUserAnalyse",data:encodeURI(getBaseFilterParams()+"&size=10&current="+page),errorMsg:"抱歉，数据加载失败",callback:function(mode){var tmp="";return!mode.model||mode.model.length<=0?(list.empty().append(['<tr class="nodata">','<td colspan="5">没有符合条件的数据</td>',"</tr>"].join("")),void exporting.hide()):(exporting.show(),$.each(mode.model,function(idx,model){var cityDTO=model.cityDTO,statisticsCrmEntity=model.statisticsCrmEntity;tmp+=['<tr class="data" data-area="',cityDTO.cityId,'" data-areaname="',cityDTO.cityName,'">',"<td>",cityDTO.cityName,"</td>","<td>",statisticsCrmEntity.totalUseCrm,"</td>","<td>",statisticsCrmEntity.totalTaskNum,"</td>","<td>",statisticsCrmEntity.totalVisitNum,"</td>","<td>",statisticsCrmEntity.totalCreateNum,"</td>","</tr>"].join("")}),list.empty().append(tmp),void pagination.init({target:".pager1",total:mode.total,eachCount:mode.size,currentPage:mode.current,callback:load}))}})}function load2(page,callback){page=void 0==page?0:page,exporting_box2.attr("href","/statisticsCrm/find/crmUserAnalyseByCityIDExportExcel?"+encodeURI(getDateFilterParams()+"&"+getOrder2ByFilterParams()+"&cityID="+cache.params.currCityId)),$.ajax({url:"/statisticsCrm/find/crmUserAnalyseByCityID",data:encodeURI(getDateFilterParams()+"&"+getOrder2ByFilterParams()+"&cityID="+cache.params.currCityId+"&size=10&current="+page),callback:function(mode){if(!mode.model||mode.model.length<=0)return list2.empty().append(['<tr class="nodata">','<td colspan="6">没有符合条件的数据</td>',"</tr>"].join("")),void exporting_box2.hide();var tmp="";exporting_box2.show(),$.each(mode.model,function(idx,model){tmp+=['<tr class="data" data-userId="',model.userID,'" data-username="',model.userName,'">',"<td>",model.userName,"</td>","<td>",model.taskNum,"</td>","<td>",model.visitCustNum,"</td>","<td>",model.createMfctyNum,"</td>","<td>",model.workDay,"</td>","<td>",model.workTime,"</td>","<td>",'<a href="mobile/crm/gztj-Bmap.do">查看</a>',"</td>","</tr>"].join("")}),list2.empty().append(tmp),pagination.init({target:".pager2",total:mode.total,eachCount:mode.size,currentPage:mode.current,callback:load2}),callback&&callback()}})}var crmGztj,common=require("common"),$=common.jquery,layer=$.layer,moment=require("moment"),loadcity=require("loadcity"),pagination=require("pagination"),laydate=require("laydate"),dataPicker=$(".datepicker"),startDate=$("#startDate"),endDate=$("#endDate"),list=$("#list"),list2=$("#list2"),province=($("#list3"),$("#province")),city=$("#city"),area=$("#area"),box2=$("#box2"),orderCol=($("#box3"),$('th[scope="sort"]')),orderCol2=($("#orderCol1"),$("#orderCol2")),breadcrumb1=($("#orderCol3"),$(".breadcrumb1")),exporting=($(".breadcrumb2"),$("#exporting")),exporting_box2=$("#exporting_box2"),cache={params:{}},_start={elem:"#startDate",format:"YYYY-MM-DD",event:"focus",choose:function(datas){_end.min=datas,_end.start=datas}},_end={elem:"#endDate",event:"focus",choose:function(datas){_start.max=datas}};laydate(_start),laydate(_end),$("#query").on("click",function(){load()}),orderCol.on("click",function(){var self=$(this),active=self.hasClass("active");self.data("val");orderCol.removeClass("active"),self.addClass(active?"":"active"),load()}),orderCol2.on("change",function(){load2()}),$(".timebtn").on("click","button.item",function(e){var _self=$(this),_siblings=_self.siblings();_self.hasClass("active")?dataPicker.removeAttr("disabled","none"):dataPicker.attr("disabled","disabled"),_siblings.removeClass("active").find(".arrow-up").addClass("fn-hide"),_siblings.find(".arrow-text").addClass("fn-hide"),_self.toggleClass("active").find(".arrow-up").toggleClass("fn-hide"),_self.find(".arrow-text").toggleClass("fn-hide");var day=_self.data("day"),today=moment().format("YYYY-MM-DD"),date=moment().subtract(day,"days").format("YYYY-MM-DD"),yesterday=moment().subtract(1,"days").format("YYYY-MM-DD"),end=day>0?yesterday:today;dataPicker.eq(0).data("date",date),dataPicker.eq(1).data("date",end),$("#startDate").val(date),$("#endDate").val(end)}),$("button.item").eq(0).trigger("click"),province.on("change",function(){var val=province.val();city.find(":not(:first)").remove(),area.find(":not(:first)").remove(),val&&loadcity.loadCity(city,val)}),city.on("change",function(){var val=city.val();val&&(area.find(":not(:first)").remove(),loadcity.loadArea(area,val))}),list.on("click","tr",function(){var _self=$(this);if(!_self.hasClass("nodata")){var areaId=_self.data("area");if(void 0!=areaId){var areaName=_self.data("areaname");cache.params.currCityId=areaId,cache.params.currCityName=areaName,breadcrumb1.text(areaName),load2(0,function(){box2.show(),cache.d2=layer.open({type:1,title:"地区详细数据",area:"1024px",content:$("#box2")})})}}}),loadTop(),loadcity.loadProvince(province),loadcity.loadAreaFull(function(model){province.val(model.proId),province.trigger("change"),load()}),module.exports=crmGztj});