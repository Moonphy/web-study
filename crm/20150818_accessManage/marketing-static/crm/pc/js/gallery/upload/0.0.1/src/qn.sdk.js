define("gallery/upload/0.0.1/src/qn.sdk",function(e,t,r){function n(e,t){this.detectIEVersion=function(){for(var e=4,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",r[0];)e++;return e>4?e:!1},this.isImage=function(e){var t,r="",n=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),r=t[1].toLowerCase();for(var a=0,o=n.length;o>a;a++)if(r===n[a])return!0;return!1},this.getFileExtension=function(e){var t,r=e.split(".");return t=1===r.length||""===r[0]&&2===r.length?"":r.pop().toLowerCase()},this.utf8_encode=function(e){if(null===e||"undefined"==typeof e)return"";var t,r,n=e+"",i="",a=0;t=r=0,a=n.length;for(var o=0;a>o;o++){var s=n.charCodeAt(o),u=null;if(128>s)r++;else if(s>127&&2048>s)u=String.fromCharCode(s>>6|192,63&s|128);else if(63488&s^!0)u=String.fromCharCode(s>>12|224,s>>6&63|128,63&s|128);else{if(64512&s^!0)throw new RangeError("Unmatched trail surrogate at "+o);var f=n.charCodeAt(++o);if(64512&f^!0)throw new RangeError("Unmatched lead surrogate at "+(o-1));s=((1023&s)<<10)+(1023&f)+65536,u=String.fromCharCode(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}null!==u&&(r>t&&(i+=n.slice(t,r)),i+=u,t=r=o+1)}return r>t&&(i+=n.slice(t,a)),i},this.base64_encode=function(e){var t,r,n,i,a,o,s,u,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=0,l=0,d="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do t=e.charCodeAt(c++),r=e.charCodeAt(c++),n=e.charCodeAt(c++),u=t<<16|r<<8|n,i=u>>18&63,a=u>>12&63,o=u>>6&63,s=63&u,p[l++]=f.charAt(i)+f.charAt(a)+f.charAt(o)+f.charAt(s);while(c<e.length);switch(d=p.join(""),e.length%3){case 1:d=d.slice(0,-2)+"==";break;case 2:d=d.slice(0,-1)+"="}return d},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(e){return window.JSON&&window.JSON.parse?window.JSON.parse(e):null===e?e:"string"==typeof e&&(e=this.trim(e),e&&/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return e}():void 0},this.trim=function(e){return null===e?"":this.trim.call(e)};var r=this;this.uploader=function(n){if(!n.browse_button)throw"browse_button is required!";var i={},a=n.init&&n.init.Error,o=n.init&&n.init.FileUploaded;n.init.Error=function(){},n.init.FileUploaded=function(){},r.uptoken_url=n.uptoken_url,r.uptoken_key=n.uptoken_key,r.domain_key=n.domain_key,r.token="",r.domain="",r.downloadUrl=n.downloadUrl,r.key_handler="function"==typeof n.init.Key?n.init.Key:"";var s="",u=function(){var i,a,o,s=r.detectIEVersion(),u="Safari"===t.Env.browser&&t.Env.version<=5&&"Windows"===t.Env.os&&"7"===t.Env.osVersion||"Safari"===t.Env.browser&&"iOS"===t.Env.os&&"7"===t.Env.osVersion;s&&9>=s&&n.chunk_size&&n.runtimes.indexOf("flash")>=0?n.chunk_size=0:u?n.chunk_size=0:(i=20,a=4<<i,o=e.parseSize(n.chunk_size),o>a&&(n.chunk_size=a))};u();var f=function(){if(n.uptoken)r.token=n.uptoken;else{var e=r.createAjax();e.open("GET",r.uptoken_url,!0),e.setRequestHeader("If-Modified-Since","0"),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var t=r.parseJSON(e.responseText);r.token=t.model[r.uptoken_key||"token"],r.domain=t.model[r.domain_key||"domain"]}},e.send()}},c=function(e,t,i){var a="",o=!1;if(!n.save_key)if(o=e.getOption&&e.getOption("unique_names"),o=o||e.settings&&e.settings.unique_names){var s=r.getFileExtension(t.name);a=s?t.id+"."+s:t.id}else a="function"==typeof i?i(e,t):t.name;return a};e.extend(i,n,{url:"http://up.qiniu.com",multipart_params:{token:""}});var l=new e.Uploader(i);return l.bind("Init",function(e,t){f()}),l.init(),l.bind("FilesAdded",function(t,r){var n=t.getOption&&t.getOption("auto_start");n=n||t.settings&&t.settings.auto_start,n&&e.each(r,function(e,r){t.start()}),t.refresh()}),l.bind("BeforeUpload",function(e,t){s="";var i=function(e,t,i){var a;a=n.save_key?{token:r.token}:{key:c(e,t,i),token:r.token};var o=n.x_vars;if(void 0!==o&&"object"==typeof o)for(var s in o)o.hasOwnProperty(s)&&("function"==typeof o[s]?a["x:"+s]=o[s](e,t):"object"!=typeof o[s]&&(a["x:"+s]=o[s]));e.setOption({url:"http://up.qiniu.com/",multipart:!0,chunk_size:void 0,multipart_params:a})},a=e.getOption&&e.getOption("chunk_size");if(a=a||e.settings&&e.settings.chunk_size,"html5"===l.runtime&&a)if(t.size<a)i(e,t,r.key_handler);else{var o=localStorage.getItem(t.name),u=a;if(o){o=JSON.parse(o);var f=(new Date).getTime(),d=o.time||0,p=864e5;p>f-d&&100!==o.percent&&t.size===localStorage.total?(t.percent=o.percent,t.loaded=o.offset,s=o.ctx,o.offset+u>t.size&&(u=t.size-o.offset)):localStorage.removeItem(t.name)}e.setOption({url:"http://up.qiniu.com/mkblk/"+u,multipart:!1,chunk_size:a,required_features:"chunks",headers:{Authorization:"UpToken "+r.token},multipart_params:{}})}else i(e,t,r.key_handler)}),l.bind("ChunkUploaded",function(e,t,n){var i=r.parseJSON(n.response);s=s?s+","+i.ctx:i.ctx;var a=n.total-n.offset,o=e.getOption&&e.getOption("chunk_size");o=o||e.settings&&e.settings.chunk_size,o>a&&e.setOption({url:"http://up.qiniu.com/mkblk/"+a}),localStorage.setItem(t.name,JSON.stringify({ctx:s,percent:t.percent,total:n.total,offset:n.offset,time:(new Date).getTime()}))}),l.bind("Error",function(t){return function(n,i){var a="",o=i.file;if(o){switch(i.code){case e.FAILED:a="\u4e0a\u4f20\u5931\u8d25\u3002\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002";break;case e.FILE_SIZE_ERROR:var s=n.getOption&&n.getOption("max_file_size");s=s||n.settings&&n.settings.max_file_size,a="\u62b1\u6b49\uff0c\u95e8\u5934\u7167\u7247\u6bcf\u5f20\u6700\u5927\u53ef\u4e0a\u4f20"+s;break;case e.FILE_EXTENSION_ERROR:a="\u6587\u4ef6\u9a8c\u8bc1\u5931\u8d25\u3002\u8bf7\u7a0d\u540e\u91cd\u8bd5\u3002";break;case e.HTTP_ERROR:var u=r.parseJSON(i.response),f=u.error;switch(i.status){case 400:a="\u8bf7\u6c42\u62a5\u6587\u683c\u5f0f\u9519\u8bef\u3002";break;case 401:a="\u5ba2\u6237\u7aef\u8ba4\u8bc1\u6388\u6743\u5931\u8d25\u3002\u8bf7\u91cd\u8bd5\u6216\u63d0\u4ea4\u53cd\u9988\u3002";break;case 405:a="\u5ba2\u6237\u7aef\u8bf7\u6c42\u9519\u8bef\u3002\u8bf7\u91cd\u8bd5\u6216\u63d0\u4ea4\u53cd\u9988\u3002";break;case 579:a="\u8d44\u6e90\u4e0a\u4f20\u6210\u529f\uff0c\u4f46\u56de\u8c03\u5931\u8d25\u3002";break;case 599:a="\u7f51\u7edc\u8fde\u63a5\u5f02\u5e38\u3002\u8bf7\u91cd\u8bd5\u6216\u63d0\u4ea4\u53cd\u9988\u3002";break;case 614:a="\u6587\u4ef6\u5df2\u5b58\u5728\u3002";try{u=r.parseJSON(u.error),f=u.error||"file exists"}catch(c){f=u.error||"file exists"}break;case 631:a="\u6307\u5b9a\u7a7a\u95f4\u4e0d\u5b58\u5728\u3002";break;case 701:a="\u4e0a\u4f20\u6570\u636e\u5757\u6821\u9a8c\u51fa\u9519\u3002\u8bf7\u91cd\u8bd5\u6216\u63d0\u4ea4\u53cd\u9988\u3002";break;default:a="\u672a\u77e5\u9519\u8bef\u3002"}a=a+"("+i.status+"\uff1a"+f+")";break;case e.SECURITY_ERROR:a="\u5b89\u5168\u914d\u7f6e\u9519\u8bef\u3002\u8bf7\u8054\u7cfb\u7f51\u7ad9\u7ba1\u7406\u5458\u3002";break;case e.GENERIC_ERROR:a="\u4e0a\u4f20\u5931\u8d25\u3002\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002";break;case e.IO_ERROR:a="\u4e0a\u4f20\u5931\u8d25\u3002\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002";break;case e.INIT_ERROR:a="\u7f51\u7ad9\u914d\u7f6e\u9519\u8bef\u3002\u8bf7\u8054\u7cfb\u7f51\u7ad9\u7ba1\u7406\u5458\u3002",l.destroy();break;default:a=i.message+i.details}t&&t(n,i,a)}n.refresh()}}(a)),l.bind("FileUploaded",function(t){return function(i,a,o){var u=function(i,a,o){if(n.downtoken_url){var s=r.createAjax();s.open("POST",n.downtoken_url,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){if(4===s.readyState)if(200===s.status){var n;try{n=r.parseJSON(s.responseText)}catch(u){throw"invalid json format"}var f={};e.extend(f,r.parseJSON(o),n),t&&t(i,a,JSON.stringify(f))}else l.trigger("Error",{status:s.status,response:s.responseText,file:a,code:e.HTTP_ERROR})},s.send("key="+r.parseJSON(o).key)}else t&&t(i,a,o)},f=r.parseJSON(o.response);if(s=s?s:f.ctx){var d="";n.save_key||(d=c(i,a,r.key_handler),d=d?"/key/"+r.URLSafeBase64Encode(d):"");var p=n.x_vars,h="",g="";if(void 0!==p&&"object"==typeof p)for(var m in p)p.hasOwnProperty(m)&&("function"==typeof p[m]?h=r.URLSafeBase64Encode(p[m](i,a)):"object"!=typeof p[m]&&(h=r.URLSafeBase64Encode(p[m])),g+="/x:"+m+"/"+h);var v="http://up.qiniu.com/mkfile/"+a.size+d+g,k=r.createAjax();k.open("POST",v,!0),k.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),k.setRequestHeader("Authorization","UpToken "+r.token),k.onreadystatechange=function(){if(4===k.readyState)if(localStorage.removeItem(a.name),200===k.status){var e=k.responseText;u(i,a,e)}else l.trigger("Error",{status:k.status,response:k.responseText,file:a,code:-200})},k.send(s)}else u(i,a,o.response)}}(o)),l},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.downloadUrl?this.downloadUrl:this.domain?this.domain:"";return t+e},this.imageAve=function(e,t){var n=r.createAjax();n.open("GET",this.getUrl(e)+"?imageAve",!0),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var e=r.parseJSON(n.responseText);t(e)}else uploader.trigger("Error",{status:n.status,response:n.responseText,file:file,code:-200})},n.send()},this.imageView2=function(e,t){var r=e.mode||"",n=e.w||"",i=e.h||"",a=e.quality||"",o=e.format||"";if(!r)return!1;if(!n&&!i)return!1;var s="imageView2/"+r;return s+=n?"/w/"+n:"",s+=i?"/h/"+i:"",s+=a?"/q/"+a:"",s+=o?"/format/"+o:"",t&&(s=this.getUrl(t)+"?"+s),s},this.imageMogr2=function(e,t){var r=e["auto-orient"]||"",n=e.thumbnail||"",i=e.strip||"",a=e.gravity||"",o=e.crop||"",s=e.quality||"",u=e.rotate||"",f=e.format||"",c=e.blur||"",l="imageMogr2";return l+=r?"/auto-orient":"",l+=n?"/thumbnail/"+n:"",l+=i?"/strip":"",l+=a?"/gravity/"+a:"",l+=s?"/quality/"+s:"",l+=o?"/crop/"+o:"",l+=u?"/rotate/"+u:"",l+=f?"/format/"+f:"",l+=c?"/blur/"+c:"",t&&(l=this.getUrl(t)+"?"+l),l},this.watermark=function(e,t){var r=e.mode;if(!r)return!1;var n="watermark/"+r;if(1===r){var i=e.image||"";if(!i)return!1;n+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(2!==r)return!1;var a=e.text?e.text:"",o=e.font?e.font:"",s=e.fontsize?e.fontsize:"",u=e.fill?e.fill:"";if(!a)return!1;n+=a?"/text/"+this.URLSafeBase64Encode(a):"",n+=o?"/font/"+this.URLSafeBase64Encode(o):"",n+=s?"/fontsize/"+s:"",n+=u?"/fill/"+this.URLSafeBase64Encode(u):""}var f=e.dissolve||"",c=e.gravity||"",l=e.dx||"",d=e.dy||"";return n+=f?"/dissolve/"+f:"",n+=c?"/gravity/"+c:"",n+=l?"/dx/"+l:"",n+=d?"/dy/"+d:"",t&&(n=this.getUrl(t)+"?"+n),n},this.imageInfo=function(e,t){if(!e)return!1;var r=this.getUrl(e)+"?imageInfo",n=this.createAjax(),i=this;n.open("GET",r,!0),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&t(i.parseJSON(n.responseText))},n.send()},this.exif=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?exif",n=this.createAjax(),i=this;return n.open("GET",r,!1),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(t=i.parseJSON(n.responseText))},n.send(),t},this.get=function(e,t){return t&&e?"exif"===e?this.exif(t):"imageInfo"===e?this.imageInfo(t):!1:!1},this.pipeline=function(e,t){var r,n,i="[object Array]"===Object.prototype.toString.call(e),a="";if(i){for(var o=0,s=e.length;s>o;o++){if(r=e[o],!r.fop)return!1;switch(r.fop){case"watermark":a+=this.watermark(r)+"|";break;case"imageView2":a+=this.imageView2(r)+"|";break;case"imageMogr2":a+=this.imageMogr2(r)+"|";break;default:n=!0}if(n)return!1}if(t){a=this.getUrl(t)+"?"+a;var u=a.length;"|"===a.slice(u-1)&&(a=a.slice(0,u-1))}return a}return!1}}r.exports={initalize:function(e){return new n(e.upload,e.moxie)}}});