BTR.define(["require","exports","module","zepto","../gallery/dialog/main","../gallery/loading/main","touch"],function(e,t,n){var r={},i=e("zepto"),s=e("../gallery/dialog/main"),o=e("../gallery/loading/main");e("touch")(i),r.$=i,r.cache={},i.ajaxSettings=i.extend(i.ajaxSettings,{timeout:1e4,dataType:"json"}),r.cache._page_loding=o(),r.setAjaxStart=function(e){return i(document).off("ajaxStart").on("ajaxStart",function(){r.cache._ajax_loding?r.cache._ajax_loding.show():r.cache._ajax_loding=o()}),i(document)},r.setAjaxStart("请求数据中...").on("ajaxBeforeSend",function(e,t,n){var i=n.url,s=i.indexOf("?");if(s!=-1){var o=i.slice(s);if(r.check.haveIllegalCharacter(o)){var u=r.utils.mapQuery(r.utils.filterParams(o));u=r.utils.encode(u);var a=r.utils.json2queryStr(u);r.log("查询字符串："+a),n.url=i.slice(0,s)+a}}}).on("ajaxComplete",function(e){r.cache._ajax_loding?r.cache._ajax_loding.close():null,r.utils.isJson(e)&&!e.success&&e.errorCode!=0&&(e.errorCode==-1?(r.msg.error("抱歉，会话已销毁，正在为你重新建立会话",3e3),setTimeout(function(){window.location.href="/mobile/login.html"})):r.msg.error("抱歉，服务器状态异常："+e.errorCode,3e3))}).on("ajaxError",function(e,t,n,s){var o=t.responseText;if(o.indexOf("500 ERROR")!="-1"){r.msg.error("抱歉，后台500错误，请稍后再试",3e3),i("section.content").empty().css({"font-size":"0.5em"}).append(s);return}if(o.indexOf("404 ERROR")!="-1"){r.msg.error("抱歉，404未找到请求的资源",3e3);return}if(o.indexOf("登录")!="-1"){r.msg.error("抱歉，会话已销毁，请退出重新进入CRM",5e3);return}r.msg.error(s+",code:"+t.status,5e3)}),function(e){e.extend(r,{log:function(e,t){window.console&&(t||window.debug)&&console[t||(t="log")]&&console[t](e)},pageLoaded:function(){e(".viewport").css({opacity:1}),setTimeout(function(){r.cache._page_loding.close()},500)}}),e.extend(r.debug={},{getSuffix:function(){return location.href.indexOf("crm.qipeipu.com")=="-1"?"?tsqq=true":""}}),e.extend(r.check={},{haveIllegalCharacter:function(e){return e.search(/\'/)!==-1},"null":function(t){return t==undefined||e.trim(t)==""||t==null},isNumber:function(e){return e.search(/^\d+$/)!==-1?!0:!1},isEmail:function(e){return e.search(/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/)!==-1?!0:!1},isPositiveNum:function(e){var t=/^[0-9]*[1-9][0-9]*$/;return t.test(e)}}),e.extend(r.utils={},{encode:function(e){for(var t in e)e[t]=encodeURIComponent(e[t]);return e},json2queryStr:function(e){var t="";for(var n in e)t+=n+"="+e[n]+"&";return r.check.null(t)?t:"?"+t.slice(t,t.length-1)},filterParams:function(e){return e.replace(/\'/,"")},toInt:function(e,t){return parseInt(e,t||10)},toFloat:function(e){return parseFloat(e)},toSingleLine:function(e){return String(e).replace(/\r/gi,"").replace(/\n/gi,"")},toHtml:function(e){return String(e).replace(/&/gi,"&amp;").replace(/\\/gi,"&#92;").replace(/\'/gi,"&#39;").replace(/\"/gi,"&quot;").replace(/</gi,"&lt;").replace(/>/gi,"&gt;").replace(/ /gi,"&nbsp;").replace(/\r\n/g,"<br />").replace(/\n\r/g,"<br />").replace(/\n/g,"<br />").replace(/\r/g,"<br />")},mapQuery:function(e){var t,n,i,e=e&&e.split("#")[0]||window.location.search,s=e.indexOf("?"),o=e.substring(s+1).split("&"),u={};if(s===-1)return u;for(t=0;t<o.length;t++)try{s=o[t].indexOf("="),n=o[t].substring(0,s),i=o[t].substring(s+1);if(!(u[n]=decodeURIComponent(i)))throw new Error("uri has wrong query string when run mapQuery.")}catch(a){r.log("错误：["+a.name+"] "+a.message+", "+a.fileName+", 行号:"+a.lineNumber+"; stack:"+typeof a.stack,2)}return u},toQueryPair:function(e,t){return encodeURIComponent(String(e))+"="+encodeURIComponent(String(t))},toQueryString:function(e){var t=[];for(var n in e)t.push(r.utils.toQueryPair(n,e[n]));return t.join("&")},encodeHtml:function(e){return e.replace(/[&'"<>\/\\\-\x00-\x09\x0b-\x0c\x1f\x80-\xff]/g,function(e){return"&#"+e.charCodeAt(0)+";"}).replace(/ /g,"&nbsp;").replace(/\r\n/g,"<br />").replace(/\n/g,"<br />").replace(/\r/g,"<br />")},encodeUrl:function(e){return escape(e).replace(/\+/g,"%2B")},isJson:function(e){return typeof e=="object"&&Object.prototype.toString.call(e).toLowerCase()=="[object object]"&&!e.length},getTotalPage:function(e,t){var n=Math.ceil(e/t);return n==0?1:n}}),e.extend(r.data={},{_storage:window.localStorage,set:function(e,t){r.utils.isJson(t)&&(t=JSON.stringify(t)),r.data._storage.setItem(e,t)},get:function(t){var n;try{n=e.parseJSON(r.data._storage.getItem(t))}catch(i){n=r.data._storage.getItem(t)}finally{return n}},remove:function(e){r.data._storage.removeItem(e)},clear:function(){r.data._storage.clear()}}),e.extend(r.msg={},{diy:function(e){return r.cache["dialog-diy"]&&r.cache["dialog-diy"].close(!0),r.cache["dialog-diy"]=new s(e),r.cache["dialog-diy"]},alert:function(e,t,n){return r.msg.diy({content:e,title:t,ok:n})},confirm:function(e,t,n){return r.msg.diy({content:e,title:"",ok:t,cancel:n})},info:function(t,n,i){return n=n==undefined?800:n,r.msg.diy({content:t,title:"alert",time:n,onclose:e.isFunction(i)?i.call(!0):null})},success:function(t,n,i){return n=n==undefined?800:n,r.msg.diy({content:t,title:"alert",time:n,onclose:e.isFunction(i)?i:null})},error:function(t,n,i){return n=n==undefined?800:n,r.msg.diy({content:t,title:"alert",time:n,onclose:e.isFunction(i)?i:null})}}),e.extend(r.state={},{check:function(t,n,i){r.utils.isJson(t)?t.success&&t.errorCode==0?t.model&&typeof t.model!="undefined"?n.call(this,t.model,t):n.call(this,null,t):e.isFunction(i)?i.call(this,t.msg,t):r.msg.info(t.msg,1e3):r.log("非json格式数据。")}})}(i),i(function(){var e=window.navigator.userAgent;e=e.toLocaleLowerCase(),/ipad|iphone|android/.test(e)?(r.mobileDevice=!0,r.CLICK="tap",r.events={click:"tap",over:"touchstart",out:"touchend"}):(r.mobileDevice=!1,r.CLICK="click",r.events={click:"click",over:"mouseover",out:"mouseout"}),r.log("event:"+r.CLICK,"log")}),n.exports=r});